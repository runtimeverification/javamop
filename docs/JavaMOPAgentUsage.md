# JavaMOPAgent Usage
Before using JavaMOPAgent, you should familiarize yourself with the
basic usage of [JavaMOP](https://github.com/runtimeverification/javamop)
and [RV-Monitor](https://runtimeverification.com/monitor/1.3/docs/).
Currently, it is not supported to have multiple .aj files as input. 
If you have multiple property files, then you need to generate a single .aj
file by executing JavaMOP with ```-merge``` option on the properties you
want to monitor. You should also have a single directory containing all the
monitor libraries (a number of .java files) generated by RV-Monitor.

## Building and using a Java Agent

###Building a Java agent
Using JavaMOPAgent, you can build Java agents for runtime instrumentation
of your applications. Once JavaMOPAgent is correctly installed, this can
be achieved by running the following command:

```javamopagent <Single-AJ-File> <Top-Dir-To-Monitor-Lib> [-n <agent name>]
[-excludeJars]```

The required ```<Single-AJ-File>``` specifies the path to the single aspectj 
file (generated by JavaMOP) with which you want to build the agent, while 
```<Top-Dir-To-Monitor-Lib>``` is the directory where all the monitor library
files (generated by RV-Monitor) are stored; The optional ```[-n <agent name>]```
specifies the name of the agent generated; ```-excludeJars``` exclude 
"rv-monitor-rt.jar" and "aspectjweaver.jar" in the generated agent, so user 
should include those jars manually on CLASSPATH before running the agent.

### Using a Java Agent

Assuming that an agent called "JavaMOPAgent.jar" has been built using
the command from the previous section, such an agent may be run as follows:

1. For projects with a well-defined entry point such as a Main class,
   first compile the source code and then run the following command:

   ```java -javaagent:JavaMOPAgent.jar Main```

   In other words, you will need to run the same command as you would
   normally use for running your Java application, but with the
   addition of the ```-javaagent:JavaMOPAgent.jar```, as shown above.


2. For Maven-based projects with tests, you can modify ```pom.xml```
to use the agent when running tests by adding following lines:

  ```xml
    <build>
    	<plugins>
    		...
        	<plugin>
	  		<groupId>org.apache.maven.plugins</groupId>
	  		<artifactId>maven-surefire-plugin</artifactId>
	  		<version>${surefire-version}</version>
	  		<configuration>
        			<argLine>-javaagent:JavaMOPAgent.jar</argLine>
	  		</configuration>
        	</plugin>
		...
      	</plugins>
     </build>
   ```

   Replace ```${surefire-version}``` with the exact surefire plugin
   version used by the project (e.g., 2.16).

   After that, you can run tests with the agent as usual by using
   ```mvn test```.

3. For Ant-based projects which have tests, you can modify
   ```build.xml``` to use the agent when running tests by adding one
   line under the ```junit``` task:

  ```xml
    <target name=...>
    	<junit ...>
    		...
        	<jvmarg value="-javaagent:JavaMOPAgent.jar"/>
		...
      	</plugins>
     </target>
   ```

   After that, you can run tests with the agent as usual by using
   ```ant ${test_target_name}```.

4. Java agent is easily integrated into IDEs like IntelliJ, Eclipse,
etc.
   
   For IntelliJ:
   click the "Run" tab 
             -> select the "Edit Configurations" tab 
             -> select the application you are running 
             -> select "configuration" tab 
             -> enter "javaagent:JavaMOPAgent.jar" in the "VM options" textbox. 
   
   For Eclipse:
   click "Run" tab 
         -> select "Run configurations" tab 
         -> select the application you are running 
         -> select "Arguments" tab 
         -> enter "javaagent:JavaMOPAgent.jar" into "VM options" textbox.
   
   By doing this, you will be able to run or debug programs with the
   agent within your IDE.
   

### An agent generation example
Suppose you have ```JavaMOP```, ```RV-Monitor``` and ```AspectJ``` installed
on your system and their executables on your Path. Furthermore, assume there
are two .mop files: `A.mop` and `B.mop` in the current directory and nothing
else. We can generate a javamop agent monitoring properties in those
specifications by executing the following commands:

1. Generate the single .aj file and .rvm files from the properties:

	```javamop -merge -keepRVFiles *.mop```

	After this step, ```MultiSpec_1MonitorAspect.aj```, ```A.rvm``` and ```B.rvm```
	will be generated.

2. Create directories for storing the monitor libraries:

	```mkdir -p classes/mop```

3. Generate the monitor libraries using RV-Monitor:

	```rv-monitor -merge -d classes/mop/ *.rvm```

	After this step, ```MultiSpec_1RuntimeMonitor.java``` will be generated in 
	folder ```classes/mop```. 

4. (Optional) Compile the monitor library file to byte code and remove .java
   source code:

	```javac classes/mop/MultiSpec_1RuntimeMonitor.java```
	```rm classes/mop/MultiSpec_1RuntimeMonitor.java```

5. Build the javamop's agent excluding the AspectJ and RV-Monitor:

	```javamopagent MultiSpec_1MonitorAspect.aj classes -n myAgent -excludeJars```

After this step, the java agent ```myAgent.jar``` will be created in the
current directory, and you can use it to monitor your code as explained in
section ```Using a Java Agent```







